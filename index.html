<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorizando</title>
    <style>
        /* Estilos do Tema Escuro (Padr√£o) */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            padding: 30px;
            margin: auto;
            background-color: #121212;
            color: #e0e0e0;
        }

        #formCadastro {
            background-color: #1e1e1e;
        }

        #NovaAnotacao {
            background-color: #333;
            color: #fff;
        }

        .caixatituloanotacoes {
            max-width: 100%;
        }

        .tituloanotacoes {
            min-height: 30px;
            min-width: 400px;
        }

        #anotacoes {
            border: 1px solid #555;
            background-color: #2b2b2b;
            color: #e0e0e0;
            min-height: 300px;
            padding: 10px;
        }

        #anotacoes div[contenteditable="false"] {
            cursor: nwse-resize;
        }

        .format-buttons button {
            background-color: #444;
            color: #e0e0e0;
        }

        .format-buttons button:hover {
            background-color: #555;
        }

        button,
        input[type="submit"],
        input[type="file"] {
            background-color: #444;
            color: #e0e0e0;
            border: none;
        }

        button:hover,
        input[type="submit"]:hover {
            background-color: #555;
        }

        .buttonsalvar {
            background-color: #007bff;
            padding: 7px 14px;
            color: white;
        }

        input[type="text"] {
            background-color: #2b2b2b;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        .btn-cor {
            padding: 8px 12px;
            background-color: #444;
            color: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: -10px;
        }
        
        #corTexto {
            margin: 22px;
            
        }

        /* Estilos do Tema Claro (Adicionados para a altern√¢ncia) */
        body.light-mode {
            background-color: #ffffff;
            color: #333;
        }

        .light-mode #formCadastro {
            background-color: #ffffff;
        }

        .light-mode #btnNovaAnotacao {
            background-color: #f1c40f;
            color: #333;
        }

        .light-mode #anotacoes {
            border: 1px solid #ccc;
            background-color: #fff;
            color: #333;
        }

        .light-mode .format-buttons button,
        .light-mode .btn-cor {
            background-color: #ffe786;
            color: #333;
        }

        .light-mode .format-buttons button:hover,
        .light-mode .btn-cor:hover {
            background-color: #f0d57e;
        }

        .light-mode button,
        .light-mode input[type="submit"],
        .light-mode input[type="file"] {
            background-color: #f0f0f0;
            color: #333;
        }

        .light-mode .buttonsalvar {
            background-color: #007bff;
            padding: 7px 14px;
            color: white;
        }

        .light-mode button:hover,
        .light-mode input[type="submit"]:hover {
            background-color: #e0e0e0;
        }

        .light-mode input[type="text"] {
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
        }

        /* Estilos existentes (mantidos para os cards e outras partes) */
        h1 {
            text-align: center;
            padding: 30px 8px;
            color: #5ba406;
        }

        .card {
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            color: #fff;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            flex: 1 1 calc(33.33% - 10px);
            box-sizing: border-box;
        }

        .card p {
            margin: 5px 0;
            overflow: hidden;
            word-break: break-word;
        }

        .status-verde {
            background-color: #77dc04;
            color: #252525;
        }

        .status-amarelo {
            background-color: #f1c40f;
            color: #252525;
        }

        .status-laranja {
            background-color: #ff7700;
        }

        .status-vermelho {
            background-color: #ff1900;
        }

        .status-roxo {
            background-color: #6001a0;
            color: #e4e4e4;
        }

        #legendaCores {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quadro {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: #fff;
            border-radius: 5px;
        }

        .status-amarelo.quadro {
            color: #000;
        }

        #botoesJson {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        form p {
            margin: 8px;
        }

        .datas {
            font-size: 10px;
            color: #1b1b1b;
            padding-bottom: 3px;
        }

        .light-mode .btn-editar {
            background-color: #638cb9;
            color: white;
        }

        .btn-editar {
            background-color: #007bff;
            color: white;
        }

        .btn-editar:hover {
            background-color: #0056b3;
        }

        .light-mode .btn-excluir {
            background-color: #d15963;
            color: white;
        }

        .btn-excluir {
            background-color: #dc3545;
            color: white;
        }

        .btn-excluir:hover {
            background-color: #a71d2a;
        }

        #cadastros {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        @media (max-width: 768px) {
            body {
                max-width: 102%;
                width: 100%;
            }

            #legendaCores {
                flex-direction: column;
            }

            #botoesJson {
                flex-direction: column;
                width: 100%;
                margin-bottom: 10px;
            }

            button {
                padding: 10px 15px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                margin: 5px;
                transition: 0.3s;
            }

             #formCadastro {
                max-width: 100%;
            }

            .tituloanotacoes {
                min-height: 30px;
                min-width: 200px;
            }

            #anotacoes {
                font-size: 15px;
                max-width: 120%;
                margin: 0;

            }

            .btn-editar {
                background-color: #007bff;
                color: white;
            }

            .btn-editar:hover {
                background-color: #0056b3;
            }

            .btn-excluir {
                background-color: #dc3545;
                color: white;
            }

            .btn-excluir:hover {
                background-color: #a71d2a;
            }

            .format-buttons button,
            .format-buttons .btn-cor {
                flex-direction: row;
                width: 25%;
            }

            .quadro {
                font-size: 14px;
                padding: 4px;
            }

            .card {
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                color: #fff;
                word-break: break-word;
                display: flex;
                flex-direction: column;
                flex: 1 1 calc(70% - 10px);
                box-sizing: border-box;
            }

            form input,
            form button {
                width: 93%;
                padding-left: 6px;
                box-sizing: border-box;
            }

            #btnAbrirForm,
            #btnNovaAnotacao,
            #btnAbrirNotificacoes {
                width: 100%;
                margin-bottom: 10px;
            }

            .light-mode #btnNovaAnotacao {
                background-color: #f1c40f;
            }

            #corTexto {
                width: 10%;
            }
        }
    </style>
</head>

<body>

    <h1>Memorizando üß†üìùüìö</h1>

    <div id="legendaCores">
        <div class="quadro status-verde">Verde: at√© 12h</div>
        <div class="quadro status-amarelo">Amarelo: 12h a 3 dias</div>
        <div class="quadro status-laranja">Laranja: 3 a 14 dias</div>
        <div class="quadro status-vermelho">Vermelho: 14 a 30 dias</div>
        <div class="quadro status-roxo">Roxo: acima de 30 dias</div>
    </div>
    <br><br>

    <div class="menubar">

        <button id="btnNovaAnotacao">Nova Anota√ß√£o ‚úèÔ∏è</button>
        <button id="btnAbrirForm">Abrir Formul√°rio üîΩ</button>

        <form id="formCadastro" style="display:none;">

            <div class="format-buttons">
                <button type="button" onclick="document.execCommand('bold', false, '');"><b>n</b></button>
                <button type="button" onclick="document.execCommand('italic', false, '');"><i>i</i></button>
                <button type="button" onclick="document.execCommand('underline', false, '');"><u>s</u></button>

                <button type="button" onclick="aumentarFonte()">A+</button>
                <button type="button" onclick="diminuirFonte()">a-</button>

                <button type="button" onclick="document.getElementById('inputImagem').click()">üñºÔ∏è Upload
                    Imagem</button>
                <input type="file" id="inputImagem" accept="image/*" style="display:none"
                    onchange="inserirImagem(event)">

                <br><br>

                <button type="button" class="btn-cor" onclick="aplicarCor()">Aplicar Cor</button>

                
                <input type="color" id="corTexto">
            </div>
            <br>
            <button class="buttonsalvar" type="submit">Salvar</button><br>
            <p class="caixatituloanotacoes">
                <label for="titulo" class="meu-label">T√≠tulo:</label>
                <input type="text" id="titulo" class="tituloanotacoes" required>
            </p>
            <p>Caixa de texto:</p>
            <div id="anotacoes" contenteditable="true"></div>

        </form>

        <button id="btnAbrirNotificacoes">Ver Notifica√ß√µes ‚ö†Ô∏è</button>

        <div id="notificacao" style="display:none;">
            <h2>‚ö†Ô∏è Notifica√ß√£o</h2>
            <button onclick="fecharNotificacao()">Fechar</button>
            <div id="conteudoNotificacao"></div>
        </div>
        <div id="botoesJson">
            <button id="btnExportar">Exportar Dados üì§</button>
            <button id="btnImportar">Importar Dados üì•</button>
            <input type="file" id="inputImportar" style="display:none" accept=".json" />
            <button id="btnToggleTheme">Alternar Tema ‚òÄÔ∏è</button>
        </div>

        <p><label for="busca">Buscar üîç</label>
            <input type="text" id="busca" placeholder="Digite t√≠tulo ou anota√ß√£o">
        </p>

        <h2>Hist√≥rico</h2>
        <div id="cadastros"></div>

        <script>
            let db;
            let editarId = null;
            let notasNotificadas = new Set();
            let emEdicao = false;

            // --- Alternar Tema e Salvar no localStorage ---
            const btnToggleTheme = document.getElementById('btnToggleTheme');

            window.addEventListener("DOMContentLoaded", () => {
                const temaSalvo = localStorage.getItem("tema");
                if (temaSalvo === "light") {
                    document.body.classList.add("light-mode");
                    btnToggleTheme.textContent = "Alternar Tema üåô";
                } else {
                    btnToggleTheme.textContent = "Alternar Tema ‚òÄÔ∏è";
                }
            });

            btnToggleTheme.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                const isLightMode = document.body.classList.contains('light-mode');
                localStorage.setItem("tema", isLightMode ? "light" : "dark");
                btnToggleTheme.textContent = isLightMode ? 'Alternar Tema üåô' : 'Alternar Tema ‚òÄÔ∏è';
            });

            // --- L√ìGICA DE FORMATA√á√ÉO DE TEXTO ---
            function aumentarFonte() {
                const anotacoes = document.getElementById('anotacoes');
                const style = window.getComputedStyle(anotacoes, null).getPropertyValue('font-size');
                const currentSize = parseFloat(style);
                anotacoes.style.fontSize = (currentSize + 1) + 'px';
            }

            function diminuirFonte() {
                const anotacoes = document.getElementById('anotacoes');
                const style = window.getComputedStyle(anotacoes, null).getPropertyValue('font-size');
                const currentSize = parseFloat(style);
                anotacoes.style.fontSize = (currentSize - 1) + 'px';
            }

            // Nova fun√ß√£o para aplicar a cor do texto quando o bot√£o √© clicado
            function aplicarCor() {
                const corSelecionada = document.getElementById('corTexto').value;
                document.execCommand('foreColor', false, corSelecionada);
            }

            document.getElementById("btnNovaAnotacao").addEventListener("click", () => {
                document.getElementById("titulo").value = "";
                document.getElementById("anotacoes").innerHTML = "";
                editarId = null;
                const form = document.getElementById("formCadastro");
                form.style.display = "block";
                document.getElementById("btnAbrirForm").textContent = "Fechar Formul√°rio ‚ùå";
                form.scrollIntoView({
                    behavior: "smooth"
                });
            });

            document.getElementById("btnAbrirForm").addEventListener("click", function () {
                const form = document.getElementById("formCadastro");
                if (form.style.display === "none" || form.style.display === "") {
                    form.style.display = "block";
                    this.textContent = "Fechar Formul√°rio ‚ùå";
                    form.scrollIntoView({
                        behavior: "smooth"
                    });
                } else {
                    form.style.display = "none";
                    this.textContent = "Abrir Formul√°rio üîΩ";
                }
            });

            let request = indexedDB.open("NotasDB", 1);
            request.onupgradeneeded = function (e) {
                db = e.target.result;
                if (!db.objectStoreNames.contains("notas"))
                    db.createObjectStore("notas", {
                        keyPath: "id",
                        autoIncrement: true
                    });
            };
            request.onsuccess = function (e) {
                db = e.target.result;
                mostrarNotas();
            };
            request.onerror = function (e) {
                alert("Erro ao abrir banco: " + e.target.errorCode);
            };

            document.getElementById("formCadastro").addEventListener("submit", function (e) {
                e.preventDefault();
                const titulo = document.getElementById("titulo").value;
                const anotacoes = document.getElementById("anotacoes").innerHTML;
                const agora = new Date().toISOString();

                if (editarId === null) {
                    salvarNota({
                        titulo,
                        anotacoes,
                        criado: agora,
                        modificado: agora
                    });
                } else {
                    emEdicao = true;
                    obterNota(editarId, (nota) => {
                        nota.titulo = titulo;
                        nota.anotacoes = anotacoes;
                        nota.modificado = agora;
                        salvarNota(nota);
                        emEdicao = false;
                    });
                    editarId = null;
                }

                this.reset();
                document.getElementById("anotacoes").innerHTML = "";
                this.style.display = "none";
                document.getElementById("btnAbrirForm").textContent = "Abrir Formul√°rio üîΩ";
            });

            function salvarNota(nota) {
                let tx = db.transaction("notas", "readwrite");
                let store = tx.objectStore("notas");
                store.put(nota).onsuccess = () => mostrarNotas();
            }

            function obterNota(id, callback) {
                let tx = db.transaction("notas", "readonly");
                let store = tx.objectStore("notas");
                let req = store.get(id);
                req.onsuccess = () => callback(req.result);
            }

            function excluirNota(id) {
                let tx = db.transaction("notas", "readwrite");
                let store = tx.objectStore("notas");
                store.delete(id).onsuccess = () => {
                    mostrarNotas();
                    notasNotificadas.delete(id);
                };
            }

            function obterCorETempo(nota) {
                const agora = new Date(),
                    modificado = new Date(nota.modificado);
                const diffMs = agora - modificado,
                    diffHoras = diffMs / (1000 * 60 * 60),
                    diffDias = diffHoras / 24;
                let corClasse = "",
                    tempoExibicao = "";
                if (diffHoras <= 12) {
                    corClasse = "status-verde";
                    tempoExibicao = `${Math.floor(diffHoras)}h`;
                } else if (diffDias <= 3) {
                    corClasse = "status-amarelo";
                    tempoExibicao = `${Math.floor(diffDias)} dia(s)`;
                } else if (diffDias <= 14) {
                    corClasse = "status-laranja";
                    tempoExibicao = `${Math.floor(diffDias)} dia(s)`;
                } else if (diffDias <= 30) {
                    corClasse = "status-vermelho";
                    tempoExibicao = `${Math.floor(diffDias)} dia(s)`;
                } else {
                    corClasse = "status-roxo";
                    tempoExibicao = `${Math.floor(diffDias)} dia(s)`;
                }
                return {
                    corClasse,
                    tempoExibicao
                };
            }

            function mostrarNotas(filtro = "") {
                if (!db) return;
                let tx = db.transaction("notas", "readonly");
                let store = tx.objectStore("notas");
                let req = store.getAll();
                req.onsuccess = function () {
                    const lista = document.getElementById("cadastros");
                    lista.innerHTML = "";
                    const notasOrdenadas = req.result.sort((a, b) => new Date(b.modificado) - new Date(a.modificado))
                        .filter(nota => ((nota.titulo + " " + nota.anotacoes).toLowerCase().includes(filtro.toLowerCase())));
                    notasOrdenadas.forEach(nota => {
                        const {
                            corClasse,
                            tempoExibicao
                        } = obterCorETempo(nota);
                        const textoResumido = nota.anotacoes.replace(/<[^>]*>?/gm, '');
                        const resumo = textoResumido.length > 100 ? textoResumido.substring(0, 100) + "..." : textoResumido;

                        lista.innerHTML += `
                            <div class="card ${corClasse}" data-id="${nota.id}">
                                <h3>${nota.titulo}</h3>
                                <p>${resumo}</p>
                                <div class="datas">
                                    Criado: ${new Date(nota.criado).toLocaleString()}<br>
                                    Modificado: ${new Date(nota.modificado).toLocaleString()}<br>
                                    Tempo decorrido: ${tempoExibicao}
                                </div>
                                <div class="edicao">
                                    <button class="btn-editar" onclick="editarNota(${nota.id})">Abrir üìù</button>
                                    <button class="btn-excluir" onclick="excluirNota(${nota.id})">Excluir ‚ùå</button>
                                </div>
                            </div>
                        `;
                    });
                };
            }

            function inserirImagem(event) {
                const arquivo = event.target.files[0];
                if (!arquivo) return;

                const leitor = new FileReader();
                leitor.onload = function (e) {
                    const wrapper = document.createElement("div");
                    wrapper.contentEditable = "false";
                    wrapper.style.display = "inline-block";
                    wrapper.style.resize = "both";
                    wrapper.style.overflow = "auto";
                    wrapper.style.maxWidth = "100%";
                    wrapper.style.border = "1px dashed #777";
                    wrapper.style.margin = "10px 0";
                    wrapper.style.padding = "2px";

                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    img.style.display = "block";

                    wrapper.appendChild(img);

                    const anotacoes = document.getElementById("anotacoes");
                    anotacoes.appendChild(wrapper);
                };
                leitor.readAsDataURL(arquivo);
            }

            document.getElementById("anotacoes").addEventListener("paste", function (event) {
                setTimeout(() => {
                    const anotacoes = document.getElementById("anotacoes");
                    const imagens = anotacoes.querySelectorAll("img:not(.resized)");

                    imagens.forEach(img => {
                        img.classList.add("resized");
                        const wrapper = document.createElement("div");
                        wrapper.contentEditable = "false";
                        wrapper.style.display = "inline-block";
                        wrapper.style.resize = "both";
                        wrapper.style.overflow = "auto";
                        wrapper.style.maxWidth = "100%";
                        wrapper.style.border = "1px dashed #777";
                        wrapper.style.margin = "10px 0";
                        wrapper.style.padding = "2px";

                        img.style.maxWidth = "100%";
                        img.style.height = "auto";
                        img.style.display = "block";

                        img.parentNode.insertBefore(wrapper, img);
                        wrapper.appendChild(img);
                    });
                }, 10);
            });

            function editarNota(id) {
                obterNota(id, (nota) => {
                    document.getElementById("titulo").value = nota.titulo;
                    document.getElementById("anotacoes").innerHTML = nota.anotacoes;
                    editarId = id;
                    document.getElementById("formCadastro").style.display = "block";
                    document.getElementById("btnAbrirForm").textContent = "Fechar Formul√°rio ‚ùå ";
                    notasNotificadas.delete(id);
                    document.getElementById("formCadastro").scrollIntoView({
                        behavior: "smooth"
                    });
                });
            }

            document.getElementById("busca").addEventListener("input", function () {
                mostrarNotas(this.value);
            });

            function mostrarNotificacao(listaNotas) {
                const div = document.getElementById("notificacao");
                const conteudo = document.getElementById("conteudoNotificacao");
                conteudo.innerHTML = "";
                listaNotas.forEach(nota => {
                    const {
                        corClasse,
                        tempoExibicao
                    } = obterCorETempo(nota);
                    const textoResumido = nota.anotacoes.replace(/<[^>]*>?/gm, '');
                    const resumo = textoResumido.length > 100 ? textoResumido.substring(0, 100) + "..." : textoResumido;

                    conteudo.innerHTML += `
                        <div class="card ${corClasse}">
                            <h3>${nota.titulo}</h3>
                            <p>${resumo}</p>
                            <small>√öltima modifica√ß√£o: ${new Date(nota.modificado).toLocaleString()}</small><br>
                            <small>Tempo decorrido: ${tempoExibicao}</small>
                        </div>`;
                });
                div.style.display = "block";
            }

            function fecharNotificacao() {
                document.getElementById("notificacao").style.display = "none";
            }

            document.getElementById("btnAbrirNotificacoes").addEventListener("click", () => {
                if (!db) return;
                let tx = db.transaction("notas", "readonly");
                let store = tx.objectStore("notas");
                let req = store.getAll();
                req.onsuccess = function () {
                    const notasRoxas = req.result.filter(nota => obterCorETempo(nota).corClasse === "status-roxo");
                    if (notasRoxas.length > 0) {
                        mostrarNotificacao(notasRoxas);
                    } else {
                        alert("N√£o h√° notifica√ß√µes roxas no momento.");
                    }
                };
            });

            document.getElementById("btnExportar").addEventListener("click", () => {
                if (!db) return;
                let tx = db.transaction("notas", "readonly");
                let store = tx.objectStore("notas");
                let req = store.getAll();
                req.onsuccess = function () {
                    const dados = JSON.stringify(req.result, null, 2);
                    const blob = new Blob([dados], {
                        type: "application/json"
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "notas.json";
                    a.click();
                    URL.revokeObjectURL(url);
                };
            });

            document.getElementById("btnImportar").addEventListener("click", () => {
                document.getElementById("inputImportar").click();
            });
            document.getElementById("inputImportar").addEventListener("change", function () {
                const arquivo = this.files[0];
                if (!arquivo) return;
                const leitor = new FileReader();
                leitor.onload = function (e) {
                    try {
                        const dados = JSON.parse(e.target.result);
                        if (!Array.isArray(dados)) throw new Error("Arquivo inv√°lido");
                        let tx = db.transaction("notas", "readwrite");
                        let store = tx.objectStore("notas");
                        dados.forEach(nota => {
                            delete nota.id;
                            store.add(nota);
                        });
                        tx.oncomplete = () => {
                            mostrarNotas();
                            alert("Importa√ß√£o conclu√≠da!");
                        };
                        tx.onerror = () => alert("Erro ao importar os dados.");
                    } catch (err) {
                        alert("Arquivo inv√°lido ou corrompido.");
                    }
                };
                leitor.readAsText(arquivo);
            });
        </script>
</body>

</html>
